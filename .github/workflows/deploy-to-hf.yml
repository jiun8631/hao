# æ–‡ä»¶å: .github/workflows/deploy-to-hf.yml

name: Build and Deploy to HF Space (v6 - Token over SSH)

on:
  push:
    branches:
      - main # å¦‚æœä½ çš„ä¸»åˆ†æ”¯æ˜¯ masterï¼Œè¯·æ”¹æˆ master

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # ç¬¬ 1 æ­¥ï¼šç°½å‡ºä½ çš„ä»£ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
          fetch-depth: 0

      # ç¬¬ 2 æ­¥ï¼šå®‰è£ä¸¦è¨­ç½® Hugo ç’°å¢ƒ
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: 'latest'
          extended: true

      # ç¬¬ 3 æ­¥ï¼šåŸ·è¡Œ Hugo æ§‹å»ºå‘½ä»¤
      - name: Build with Hugo
        run: hugo --minify

      # ç¬¬ 4 æ­¥ï¼šä½¿ç”¨ Access Token é€²è¡Œ SSH å”è­°éƒ¨ç½²
      # âš ï¸ é€™æ˜¯å”¯ä¸€éœ€è¦ä½ ä¿®æ”¹çš„åœ°æ–¹ âš ï¸
      - name: Deploy to HF Space via Token over SSH
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_USER: "hang3976"     # ğŸ‘ˆ æŠŠå®ƒæ›æˆä½ çš„ HF ç”¨æˆ¶å
          SPACE_NAME: "hao"  # ğŸ‘ˆ æŠŠå®ƒæ›æˆä½ çš„ Space å
        run: |
          # é…ç½® SSH ç’°å¢ƒï¼Œè‡ªå‹•æ¥å— hf.co çš„ä¸»æ©Ÿå¯†é‘°
          mkdir -p ~/.ssh
          ssh-keyscan hf.co >> ~/.ssh/known_hosts

          # é€²å…¥ Hugo ç”Ÿæˆçš„ public æ–‡ä»¶å¤¾
          cd public
          
          # åˆå§‹åŒ– Git å€‰åº«
          git init
          
          # å®‰è£ä¸¦é…ç½® Git LFS
          git lfs install
          echo '* filter=lfs diff=lfs merge=lfs' > .gitattributes
          
          # é…ç½® Git ç”¨æˆ¶ä¿¡æ¯
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          
          # ã€ã€ã€ é—œéµæ”¹å‹•è™• ã€‘ã€‘ã€‘
          # æ§‹é€ ä¸€å€‹ç‰¹æ®Šçš„ SSH URLï¼Œæ ¼å¼ç‚º git@hf.co:spaces/ç”¨æˆ¶å/Spaceå
          # Git åœ¨ä½¿ç”¨é€™å€‹ URL æ™‚ï¼Œæœƒæç¤ºè¼¸å…¥å¯†ç¢¼ï¼Œæˆ‘å€‘å°‡ä½¿ç”¨ HF_TOKEN ä½œç‚ºå¯†ç¢¼
          HF_SPACE_GIT_SSH_URL="git@hf.co:spaces/${HF_USER}/${SPACE_NAME}"
          
          # æ·»åŠ é ç¨‹å€‰åº«
          git remote add hf_space "${HF_SPACE_GIT_SSH_URL}"
          
          # æ·»åŠ æ‰€æœ‰æ–‡ä»¶ä¸¦æäº¤
          git add .
          git commit -m "Deploy from GitHub Action ${{ github.sha }}"
          
          # ã€ã€ã€ é—œéµæ”¹å‹•è™• ã€‘ã€‘ã€‘
          # è¨­ç½®ä¸€å€‹è‡¨æ™‚çš„ GIT_SSH_COMMANDï¼Œå®ƒæœƒä½¿ç”¨ `sshpass` å·¥å…·è‡ªå‹•è¼¸å…¥å¯†ç¢¼
          # é€™æ¨£å°±å¯ä»¥åœ¨éäº¤äº’ç’°å¢ƒä¸‹å®Œæˆéœ€è¦å¯†ç¢¼çš„ SSH æ“ä½œ
          sudo apt-get update && sudo apt-get install -y sshpass
          export GIT_SSH_COMMAND="sshpass -p '${HF_TOKEN}' ssh"
          
          # å¼·åˆ¶æ¨é€åˆ° HF Space çš„ main åˆ†æ”¯
          git push --force -u hf_space main
